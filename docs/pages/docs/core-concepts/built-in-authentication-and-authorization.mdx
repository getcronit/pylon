import {Callout} from '@components/callout'

# Built-in Authentication and Authorization

Pylon now offers an enhanced, streamlined authentication system. With this update, the auth endpoint automatically creates routes for **/auth/login**, **/auth/callback**, and **/auth/logout**. When a user authenticates, Pylon sets an `auth` object in the context variables and automatically manages a cookie with the token—simplifying session management and ensuring a secure experience.

---

## General Setup

Before you begin, configure your environment to integrate with your authentication provider (e.g., ZITADEL). The new configuration uses the `useAuth` plugin to initialize authentication routes and settings.

```typescript
import {
  app,
  PylonConfig,
  requireAuth,
  useAuth,
  authMiddleware
} from '@getcronit/pylon'

export const config: PylonConfig = {
  plugins: [
    useAuth({
      issuer: 'https://test-0o6zvq.zitadel.cloud',
      endpoint: '/auth', // optional, default is '/auth'
      keyPath: 'key.json' // optional, default is 'key.json'
    })
  ]
}
```

**How it works:**

- **Auth Routes:**  
  The plugin automatically creates routes for:

  - `/auth/login`
  - `/auth/callback`
  - `/auth/logout`

- **Context & Cookie:**  
  After authentication, an `auth` object is added to your context, and a cookie containing the token is set for subsequent requests.

<Callout type="note" title="Important">
  Ensure that your API application is configured to use a **Private JWT Key**
  type for secure token management.
</Callout>

---

## Authentication Example

To protect sensitive data, use the `requireAuth` decorator. In the example below, any user trying to access the data must be authenticated:

```typescript
// Define a service for sensitive data
class SensitiveData {
  @requireAuth()
  static async getData() {
    return 'Sensitive Data'
  }
}

// Expose the resolver via GraphQL
export const graphql = {
  Query: {
    sensitiveData: SensitiveData.getData
  }
}

export default app
```

In this setup, the `@requireAuth()` decorator ensures that only authenticated users can access the `getData` method. If the user is not authenticated, they will be redirected to the login flow at `/auth/login`.

---

## Authorization Example

If you need to restrict access based on roles, you can pass a roles array to the `requireAuth` decorator. For instance, the following example limits access to users with the `"admin"` role:

```typescript
// Define a service for admin-only data
class SensitiveData {
  @requireAuth({
    roles: ['admin']
  })
  static async getAdminData() {
    return 'Admin Data'
  }
}

// Expose the resolver via GraphQL
export const graphql = {
  Query: {
    sensitiveAdminData: SensitiveData.getAdminData
  }
}

export default app
```

Only authenticated users who have the `"admin"` role will be allowed to access `getAdminData()`. Roles should be managed in your authentication provider (e.g., ZITADEL) for centralized control over permissions.

---

## Securing Routes with Middleware

In addition to securing individual resolvers, you can enforce authentication and authorization for entire routes using the new `authMiddleware`. For example, to secure a specific REST endpoint:

```typescript
import {authMiddleware} from '@getcronit/pylon'

// Secure all routes under /admin to only allow users with the 'admin' role
app.use(
  '/admin',
  authMiddleware({
    roles: ['admin']
  })
)

// Secure specific route to only allow users with the 'admin' role
app.get(
  '/secure',
  authMiddleware({
    roles: ['admin']
  }),
  c => {
    return c.json({data: 'sensitive'})
  }
)
export default app
```

In this case, any request to the `/admin` route will first pass through `authMiddleware`, ensuring that the user is authenticated and has the required `"admin"` role.
The same applies to the `/secure` route, which is secured with the `authMiddleware` middleware.

---

## Further Resources

For additional guidance on integrating with your authentication provider, please refer to the following resources:

- [ZITADEL Projects Documentation](https://zitadel.com/docs/guides/manage/console/projects)
- [ZITADEL Applications Documentation](https://zitadel.com/docs/guides/manage/console/applications#api)
- [ZITADEL Roles Documentation](https://zitadel.com/docs/guides/manage/console/roles)

---

## Conclusion

With the new built-in authentication and authorization features, Pylon makes securing your web services simpler than ever. The automatic route creation, context management, and cookie handling streamline the login flow, while decorators and middleware give you granular control over access to your application’s data and routes. Enjoy a secure and seamless user experience with minimal configuration!
